---
title: CI/CD에서
date: 2024-01-10
comments: true
categories:
  - posts
tags:
  - ci/cd
---

---

## CI/CD란?

테스트(Test),통합(Merge),배포(Deploy)의 과정을 자동화하는 것을 의미합니다.
<br>
배포를 할때 직접 컴퓨터 서버에 접속해서 새로운 코드를 다운받아 실행시켜주어야 한다.

<img src="/assets/ci-cd/img.png" alt="cicd" itemprop="image">
<br>

코드를 수정하고 나서 이것을 서버에 반영을 하고 싶다면, 다시 앞에 언급했던 과정(서버에 접속 -> 새로운 코드 다운 -> 실행)을 반복해야하므로 이러한 반복을 자동화 시키기 위한 것이라고 볼 수 있습니다.

## CI/CD tool들

- GitHub Actions
- Jenkins
- Circle Cl
- Travis Cl

## GitHub Actions란?
로직을 실행시킬 수 있는 컴퓨터라고 보면 됩니다.
CI/CD과정에서는 "빌드,테스트,배포" 로직을 실행시키는 역할을 합니다.

## CI/CD의 흐름!

<img src="/assets/ci-cd/image.png" alt="cicd2" itemprop="image">
<br>

1.코드 커밋
2.gihub push
3.push하면 바로 github actions에서 작성한 로직 실행
4.서버에서 배포된 최신 코드로 서버 재실행

## Github Actions 기본 문법

① .github 폴더 생성 <br>
② 생성한 폴더 하위에 workflows 생성 <br>
<br>
위 폴더들의 이름은 틀리면 안되고, 루트 경로에 있어야 함. <br>
③ workflows 하위에 yml 파일 만듦 <br>
④ Github Actions에서 실행할 코드들 작성 <br>

<br>
// Workflow라고 하자

```yaml
name: Github Actions 실행시켜보기 # 워크플로우의 이름

# 실행되는 시점을 설정 할 수 있음.
on:
  push:
    branches:
      - main # main이라는 브랜치로 push 될 때 아래 workflow를 실행한다는 의미

# 하나의 워크플로우는 1개 이상의 job으로 구성됨.
# 여러 JOB은 기본적으로 병렬적으로 수행된다.
jobs:
  My-Deploy-Job: ## 임의대로 붙여도 됨. JOB 식별 id라고 보면됨.
    runs-on: ubuntu-latest # JOB을 실행하는 ubuntu 환경/ 가장 최신 버전(latest)

    # Step: 특정 작업을 수행하는 가장 작은 단위
    # Job은 여러 Step들로 구성되어 있다.
    # $GITHUB_SHA 커밋 ID
    # $GITHUB_REPOSITORY 레포지토리 명
    # secrets는 레포지토리 세팅탭에서 변수 값지정 가능
    steps:
      - name: Hello World 찍기
        run: echo "Hello World"
    
      - name: 여러 명령어 문장 작성하기
        run: |
          echo "Good"
          echo "Perfect"
          
      - name: Gihub Actions 자체에 저장되어 있는 변수 사용해서 출력
        run: |
            echo $GITHUB_SHA 
            echo $GITHUB_REPOSITORY
          
      - name: 아무한테 노출이 되면 안 되는 값
        run: |
          echo ${{ secrets.MY_NAME }}
          echo ${{ secrets.MY_DOGS_NAME }}

```

## Github Actions 흐름

<img src="/assets/ci-cd/img_1.png" alt="cicd3" itemprop="image">
<br>

- 대부분의 CI/CD는 전체 프로젝트를 통째로 갈아끼우는 방식 사용

<br>

## 원래 순서
1.ec2 생성 <br>
2.서버에 접속 <br>
3.sudo apt-get update <br>
4.java 설치 <br>
5.git clone <br>
6.프로젝트 빌드 <br>
- cd build/libs <br>
- ./gradlew clean build <br>
-  nohup java -jar cicd-test-0.0.1-SNAPSHOT.jar & <br>
- sudo lsof -i:8080 -> PID 확인 <br>
- sudo fuser -k -n tcp 8080 -> PID로 프로세스 종료 <br> 


해당 사항들을 자동화 시키는 것이 CI/CD입니다.

### Tips
git config --global credential.helper store <br>
: git push 할 때마다 계정과 비밀번호를 입력하는 것이 귀찮다면 이 명령어를 입력하면 된다. <br>


## Github Actions를 이용한 개인용 CI/CD 

```cicd
name: Deploy To EC2

on:
  push:
    branches:
      - main

# uses 에는 사용할 라이브러리 이름과 버전을 적어준다.
# sudo fuser -k -n tcp 8080  8080 포트를 사용하는 프로세스를 종료
# || true : 에러가 발생해도 계속 실행
# ./output.log 2>&1 : output.log 파일에 로그를 저장

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: SSH(원격 접속)로 EC2에 접속
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script_stop: true
          script: |
            cd /home/ubuntu/github-actions-pr-2
            git pull origin main
            ./gradlew clean build
            sudo fuser -k -n tcp 8080 || true 
            nohup java -jar build/libs/*SNAPSHOT.jar > ./output.log 2>&1 &
```
## yml 파일을 추적하지 않고 자동화하기

```cicd
name: Deploy To EC2

on:
  push:
    branches:
      - main

# uses 에는 사용할 라이브러리 이름과 버전을 적어준다.
# sudo fuser -k -n tcp 8080  8080 포트를 사용하는 프로세스를 종료
# || true : 에러가 발생해도 계속 실행
# ./output.log 2>&1 : output.log 파일에 로그를 저장

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: SSH(원격 접속)로 EC2에 접속
        uses: appleboy/ssh-action@v1.0.3
        env:
          APPLICATION_PROPERTIES: ${{ secrets.APPLICATION_PROPERTIES }} ## application.yml 파일을 secrets에 복사 붙여넣기
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          envs: APPLICATION_PROPERTIES ## 환경변수로 사용
          script_stop: true
          script: |
            cd /home/ubuntu/github-actions-pr-2
            rm -rf scr/main/resources/application.yml || true
            rm -rf scr/main/resources/application.properties || true
            
            git pull origin main
            
            echo "$APPLICATION_PROPERTIES" > src/main/resources/application.yml
             ## application.yml 파일을 생성
            ./gradlew clean build
            sudo fuser -k -n tcp 8080 || true 
            nohup java -jar build/libs/*SNAPSHOT.jar > ./output.log 2>&1 &
```


## application.yml관리하기
- APPLICATION_PROPERTIES에 복사 붙여넣기 <br>
- 생성된 것 확인 <br>

해당 부분은 수동으로 진행해야 한다.

## 참고
- git rm -r --cached (#git에 올라간 파일 삭제)

## Github Actions를 이용한 팀프로젝트 CI/CD

```cicd
name: Deploy To EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Github Repository에 올린 파일들을 불러오기
        uses: actions/checkout@v4

      - name: JDK 17버전 설치
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: application.yml 파일 만들기
        run: echo "${{ secrets.APPLICATION_PROPERTIES }}" > src/main/resources/application.yml

      - name: 테스트 및 빌드하기
        run: ./gradlew clean build

      - name: 빌드된 파일 이름 변경하기
        run: mv ./build/libs/*SNAPSHOT.jar ./project.jar

      ## 업데이트된 파일을 tobe폴더에 넣어두기
      - name: SCP로 EC2에 빌드된 파일 전송하기
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          source: project.jar
          target: /home/ubuntu/cicd-server/tobe


      ## tobe폴더에 있는 파일을 current폴더로 옮기기
      - name: SSH(원격 접속)로 EC2에 접속
        uses: appleboy/ssh-action@v1.0.3
        env:
          APPLICATION_PROPERTIES: ${{ secrets.APPLICATION_PROPERTIES }}
        with:
            host: ${{ secrets.EC2_HOST }}
            username: ${{ secrets.EC2_USERNAME }}
            key: ${{ secrets.EC2_PRIVATE_KEY }}
            script: |
                rm -rf /home/ubuntu/cicd-server/current
                mkdir /home/ubuntu/cicd-server/current
                mv /home/ubuntu/cicd-server/tobe/project.jar /home/ubuntu/cicd-server/current/project.jar
                cd /home/ubuntu/cicd-server/current
                sudo fuser -k -n tcp 8080 || true
                nohup java -jar project.jar > ./output.log 2>&1 &
                rm -rf /home/ubuntu/cicd-server/tobe
```

- 이 current 파일에 기존에 실행시킨 jar파일이 있기 때문에 <br>

- 폴더를 지워버리고 새롭게 만들어서 옛날 거를 이제 없애버리고 새로운 거를 current 폴더로 옮겨버리는 과정
- 이 과정을 통해서 기존 서버 종료하고 새롭게 전달한 jar 파일 실행



## 결론
